<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Climate Experiment</title>

  <!-- jsPsych core + plugins from CDN -->
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions"></script>

  <!-- Link to external CSS file -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <noscript>JavaScript is required to run this experiment.</noscript>
  <div id="jspsych-target"></div>

  <script>
    console.log("✅ sequential_climate.html loaded");

    // ==== CONFIG ====
    const YEAR_START = 1981;
    const YEAR_END   = 2020;

    // Initialize jsPsych
    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
      // final saving happens in the last trial's on_finish below
    });

// === CONSENT FORM ===
const consent = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <iframe src="consent_form.html"
      style="width:100%;height:600px;border:none;border-radius:8px;"></iframe>
    <div style="text-align:center;margin-top:20px;">
      <label style="display:block;margin-bottom:16px;font-size:15px;cursor:pointer;">
        <input type="checkbox" id="consent-checkbox" style="margin-right:8px;cursor:pointer;">
        I have read and understood the above information and consent to participate in this study.
      </label>
      <button id="consent-continue"
        style="background:#0066cc;color:white;padding:12px 24px;
               border:none;border-radius:6px;font-size:16px;cursor:pointer;opacity:0.5;"
        disabled>
        Continue
      </button>
      <button id="consent-decline"
        style="background:#6c757d;color:white;padding:12px 24px;
               border:none;border-radius:6px;font-size:16px;cursor:pointer;margin-left:12px;">
        Decline
      </button>
    </div>
  `,
  choices: "NO_KEYS",
  on_load: () => {
    const checkbox = document.getElementById("consent-checkbox");
    const continueBtn = document.getElementById("consent-continue");
    const declineBtn = document.getElementById("consent-decline");

    // Enable/disable continue button based on checkbox
    checkbox.addEventListener("change", () => {
      if (checkbox.checked) {
        continueBtn.disabled = false;
        continueBtn.style.opacity = "1";
        continueBtn.style.cursor = "pointer";
      } else {
        continueBtn.disabled = true;
        continueBtn.style.opacity = "0.5";
        continueBtn.style.cursor = "not-allowed";
      }
    });

    // Handle continue click
    continueBtn.addEventListener("click", () => {
      if (checkbox.checked) {
        jsPsych.data.addProperties({ consented: true });
        jsPsych.finishTrial(); // advance to next trial
      }
    });

    // Handle decline click
    declineBtn.addEventListener("click", () => {
      jsPsych.data.addProperties({ consented: false });
      // Show thank you screen and end experiment
      document.getElementById("jspsych-target").innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:80vh;">
          <h2 style="font-size:24px;color:#333;">Thank you</h2>
        </div>
      `;
    });
  }
};
    
  const timeline = [consent];

    // === Intro ===
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        `<div class="center-screen"><div>
          <h2>Welcome!</h2>
          <p>In this experiment you will be given some information about a fictional town named "Townsville".</p>
        </div></div>`,
        `<div class="center-screen"><div>
        <p>Townsville is a winter town. During the holiday season, Townsville is known for its chilly, low winter temperatures. Historically, its local lake has attracted tourists for ice-skating during the holiday months. </p>
        <p>Click "Next" to continue.</p></div></div>`,
      ],
      show_clickable_nav: true
    });

    // === Random condition assignment (on each page load) ===
    const dataset_files = [
      "binary_0.243148164557317_.csv",
      "binary_0.496276430097968_.csv",
      "binary_0.670408510834097_.csv",
      "continuous_0.243148164557317_.csv",
      "continuous_0.496276430097968_.csv",
      "continuous_0.670408510834097_.csv"
    ];

    // Randomly choose binary or continuous condition
    const condition = Math.random() < 0.5 ? "binary" : "continuous";

 
    const candidates = dataset_files.filter(f => f.startsWith(condition));
    const chosen_file = jsPsych.randomization.sampleWithoutReplacement(candidates, 1)[0];

    const is_binary = condition === "binary";
    console.log("Chosen:", { condition, chosen_file, YEAR_START, YEAR_END });

    // Condition announcement
    //can we break this down into two screens? Put the ["Important ..."] in a different screen
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus:
        `<div class="center-screen"><div>
         <p>In the next screens, you will see a sequence of data that will show ${
  is_binary
    ? "<strong>whether or not the lake of Townsville froze</strong> for a particular year."
    : "<strong>the average winter temperature</strong> for a particular year."
}</p>
<p>${
  is_binary
    ? "A year which says YES means that the lake froze over completely and was deemed safe for ice skating. A year which says NO means the lake did not freeze completely."
    : "The average winter temperature is taken by averaging the daily temperature in Fahrenheit over the months: November, December, and January."
}</p>

          <p><strong>Important:</strong> Data will be shown to you <strong>one year at a time</strong> from 1980-2020 and will disappear. Each datapoint will be shown to you for <strong> only 1 second before disappearing</strong>. We request you to please pay attention to the trend as much as possible.</p>
          <p>Press any key to begin the experiment.</p>
        </div></div>`
    });

    // === Load and parse the CSV ===
    fetch(chosen_file)
      .then(r => {
        if (!r.ok) throw new Error(`Could not load ${chosen_file} (status ${r.status})`);
        return r.text();
      })
      .then(csvText => {
        const lines = csvText.trim().split("\n");
        const rawRows = lines.map(line => line.split(","));
        const bodyRows = rawRows[0] && isNaN(parseInt(rawRows[0][0], 10)) ? rawRows.slice(1) : rawRows;

        const rows = bodyRows
          .map(r => [r[0]?.trim(), r[1]?.trim()])
          .filter(([y, v]) => {
            const yr = parseInt(y, 10);
            return Number.isFinite(yr) && yr >= YEAR_START && yr <= YEAR_END && v !== undefined && v !== "";
          })
          .sort((a, b) => parseInt(a[0], 10) - parseInt(b[0], 10));

        if (rows.length === 0) throw new Error(`No data rows found between ${YEAR_START} and ${YEAR_END}.`);

        const yearsAvailable = rows.map(r => parseInt(r[0], 10));
        const halfwayIndex = Math.floor(rows.length / 2);

        const attentionWords = ["apple", "house", "tree", "book", "dog"];
        const attentionWord  = attentionWords[Math.floor(Math.random() * attentionWords.length)];

        // sequential datapoints
        rows.forEach((row, index) => {
          const year  = row[0];
          const value = row[1];
          let display;

          if (is_binary) {
            display = `Year: ${year} | Lake Freeze: ${value}`;
          } else {
            const celsius    = parseFloat(value);
            const fahrenheit = (celsius * 9/5 + 32).toFixed(1);
            display = `Year: ${year} | Avg Temp: ${fahrenheit}°F`;
          }

          if (index === halfwayIndex) {
            timeline.push({
              type: jsPsychHtmlKeyboardResponse,
              stimulus:
                `<div class="center-screen"><div>
                   <p><strong>Attention Check</strong></p>
                   <p>Please remember this word:</p>
                   <p style="font-size:48px; margin: 10px 0;"><strong>${attentionWord}</strong></p>
                   <p class="small-note">You'll be asked for it at the end.</p>
                 </div></div>`,
              choices: "NO_KEYS",
              trial_duration: 3000,
              data: { trial_type: "attention_word_display", attention_word: attentionWord }
            });
          }

          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<div class="center-screen"><div>${display}</div></div>`,
            choices: "NO_KEYS",
            trial_duration: 2500,
            data: { trial_type: "datapoint", index, year, value }
          });
        });

        // Likert
        timeline.push({
          type: jsPsychSurveyLikert,
          preamble: "<h3>Perceptions of Climate Change</h3>",
          questions: [
            { prompt: "In your view, how much do you think the temperature of the town has changed in the last 40 years?",
              labels: ['1 (remained the same)', '','','','','','','','', '10 (changed a lot)'],
              required: true, name: "temperature impact_rating" },
            { prompt: "In your view, how much do you think the frequency at which the lake freezes has changed in Townsville in the last 40 years?",
              labels: ['1 (remained the same)', '','','','','','','','', '10 (changed a lot)'],
              required: true, name: "freeze impact_rating" },
            { prompt: "In your view, how much do you think Townsville has been affected by climate change?",
              labels: ['1 (not affected at all)', '','','','','','','','', '10 (extremely affected)'],
              required: true, name: "climate impact_rating" },
          ],
          data: { trial_type: "perception_ratings" }
        });

    

        // Attention recall
        timeline.push({
          type: jsPsychSurveyText,
          preamble: "<h3>Memory Check</h3>",
          questions: [{ prompt: "What word was shown earlier?", name: "attention_recall", required: true }],
          on_finish: (data) => {
            try {
              const resp = JSON.parse(data.responses).attention_recall || "";
              data.trial_type = "attention_recall";
              data.attention_word = attentionWord;
              data.correct = String(resp).trim().toLowerCase() === attentionWord.toLowerCase();
            } catch (_) {}
          }
        });


        // === DEBRIEF & SAVE ===
        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
            <iframe src="debriefing.html"
              style="width:100%;height:600px;border:none;border-radius:8px;"></iframe>
            <div style="text-align:center;margin-top:20px;">
              <p>Thank you for your participation!</p>
              <button id="acknowledge-btn"
                style="background:#0066cc;color:white;padding:12px 32px;
                       border:none;border-radius:6px;font-size:16px;cursor:pointer;margin-top:16px;">
                I Acknowledge
              </button>
            </div>
          `,
          choices: "NO_KEYS",
          on_load: () => {
            document.getElementById("acknowledge-btn").addEventListener("click", async () => {
              // Save data
              const payload = {
                meta: {
                  condition: is_binary ? "binary" : "continuous",
                  dataset_file: chosen_file,
                  finished_at: new Date().toISOString()
                },
                json: jsPsych.data.get().values(),
                csv: jsPsych.data.get().csv()
              };

              try {
                await fetch("/experiment-data", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
                });
                
                // Show thank you
                document.getElementById("jspsych-target").innerHTML = `
                  <div class="center-screen"><div>
                    <h1 style="font-size:48px;margin-bottom:16px;">Thank You!</h1>
                    <p style="font-size:24px;">Your participation is complete.</p>
                  </div></div>
                `;
              } catch (err) {
                console.error("Save failed:", err);
                alert("Data could not be saved. Please contact the researcher.");
              }
            });
          }
        });

jsPsych.run(timeline);

      })
      .catch(error => {
        document.getElementById("jspsych-target").innerHTML =
          `<p style="color:#b00">Error loading CSV "<b>${chosen_file}</b>": ${error.message}</p>`;
        console.error(error);
      });
  </script>
</body>
</html>
