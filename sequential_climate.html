<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Climate Experiment</title>

<!-- ✅ jsPsych core and CSS -->
<script src="https://unpkg.com/jspsych@7.3.0"></script>
<link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

<!-- ✅ Plugins (UMD versions that define global variables) -->
<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.2.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@jspsych/plugin-survey-text@1.2.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.2.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.2.0/dist/index.umd.js"></script>
<script src="https://unpkg.com/@jspsych/plugin-instructions@1.2.0/dist/index.umd.js"></script>




  <style>
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #f7f7f7;
    }
    #jspsych-target {
      max-width: 820px;
      margin: 40px auto;
      padding: 32px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .center-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      font-size: 22px;
      line-height: 1.5;
    }
    .small-note {
      font-size: 14px;
      opacity: .75;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <noscript>JavaScript is required to run this experiment.</noscript>
  <div id="jspsych-target"></div>

  <script>
    console.log("✅ sequential_climate.html loaded");

    const YEAR_START = 1981;
    const YEAR_END = 2020;

    const jsPsych = initJsPsych({
      display_element: "jspsych-target"
    });

    const timeline = [];

    /* === ✅ LOAD CONSENT FORM === */
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: async function() {
        const html = await fetch("consent_form.html").then(r => r.text());
        return html + `<p><strong>Press any key to continue.</strong></p>`;
      }
    });

    // === Intro ===
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        `<div class="center-screen"><div>
          <h2>Welcome!</h2>
          <p>In this experiment you will be given some information about a fictional town named "Townsville".</p>
        </div></div>`,
        `<div class="center-screen"><div>
        <p>Townsville is a winter town. During the holiday season, Townsville is known for its chilly, low winter temperatures. Historically, its local lake has attracted tourists for ice-skating during the holiday months. </p>
        <p>Click "Next" to continue.</p></div></div>`,
      ],
      show_clickable_nav: true
    });

    // === Balanced condition assignment ===
    const dataset_files = [
      "binary_0.243148164557317_.csv",
      "binary_0.496276430097968_.csv",
      "binary_0.670408510834097_.csv",
      "continuous_0.243148164557317_.csv",
      "continuous_0.496276430097968_.csv",
      "continuous_0.670408510834097_.csv"
    ];

    let chosen_file = localStorage.getItem("climate_chosen_file");
    let condition = localStorage.getItem("climate_condition");

    if (!chosen_file || !condition) {
      const counts = JSON.parse(localStorage.getItem("climate_cond_counts") || '{"bin":0,"cont":0}');
      if (counts.bin < counts.cont) condition = "binary";
      else if (counts.cont < counts.bin) condition = "continuous";
      else condition = Math.random() < 0.5 ? "binary" : "continuous";

      const candidates = dataset_files.filter(f => f.startsWith(condition));
      chosen_file = jsPsych.randomization.sampleWithoutReplacement(candidates, 1)[0];

      localStorage.setItem("climate_chosen_file", chosen_file);
      localStorage.setItem("climate_condition", condition);
      const newCounts = { ...counts };
      if (condition === "binary") newCounts.bin++; else newCounts.cont++;
      localStorage.setItem("climate_cond_counts", JSON.stringify(newCounts));
    }

    const is_binary = condition === "binary";
    console.log("Chosen:", { condition, chosen_file, YEAR_START, YEAR_END });

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div class="center-screen"><div>
        <p>In the next screens, you will see a sequence of data that will show ${
          is_binary
            ? "<strong>whether or not the lake of Townsville froze</strong> for a particular year."
            : "<strong>the average winter temperature</strong> for a particular year."
        }</p>
        <p>${
          is_binary
            ? "A year which says YES means that the lake froze over completely and was deemed safe for ice skating. A year which says NO means the lake did not freeze completely."
            : "The average winter temperature is taken by averaging the daily temperature in Fahrenheit over the months: November, December, and January."
        }</p>
        <p><strong>Important:</strong> Data will be shown to you <strong>one year at a time</strong> from 1980–2020 and will disappear. Each datapoint will be shown for <strong>only 1 second</strong>. Please pay attention to the trend.</p>
        <p>Press any key to begin the experiment.</p>
      </div></div>`
    });

    // === Load and parse CSV ===
    fetch(chosen_file)
      .then(r => {
        if (!r.ok) throw new Error(`Could not load ${chosen_file} (status ${r.status})`);
        return r.text();
      })
      .then(csvText => {
        const lines = csvText.trim().split("\n");
        const rawRows = lines.map(line => line.split(","));
        const bodyRows = rawRows[0] && isNaN(parseInt(rawRows[0][0], 10)) ? rawRows.slice(1) : rawRows;

        const rows = bodyRows
          .map(r => [r[0]?.trim(), r[1]?.trim()])
          .filter(([y, v]) => {
            const yr = parseInt(y, 10);
            return Number.isFinite(yr) && yr >= YEAR_START && yr <= YEAR_END && v !== undefined && v !== "";
          })
          .sort((a, b) => parseInt(a[0], 10) - parseInt(b[0], 10));

        if (rows.length === 0)
          throw new Error(`No data rows found between ${YEAR_START} and ${YEAR_END}.`);

        const yearsAvailable = rows.map(r => parseInt(r[0], 10));
        const halfwayIndex = Math.floor(rows.length / 2);
        const attentionWords = ["apple", "house", "tree", "book", "dog"];
        const attentionWord = attentionWords[Math.floor(Math.random() * attentionWords.length)];

        rows.forEach((row, index) => {
          const [year, value] = row;
          let display = is_binary
            ? `Year: ${year} | Lake Freeze: ${value}`
            : `Year: ${year} | Avg Temp: ${(parseFloat(value) * 9 / 5 + 32).toFixed(1)}°F`;

          if (index === halfwayIndex) {
            timeline.push({
              type: jsPsychHtmlKeyboardResponse,
              stimulus: `<div class="center-screen"><div>
                <p><strong>Attention Check</strong></p>
                <p>Please remember this word:</p>
                <p style="font-size:48px; margin: 10px 0;"><strong>${attentionWord}</strong></p>
                <p class="small-note">You'll be asked for it at the end.</p>
              </div></div>`,
              choices: "NO_KEYS",
              trial_duration: 3000
            });
          }

          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `<div class="center-screen"><div>${display}</div></div>`,
            choices: "NO_KEYS",
            trial_duration: 2000
          });
        });

        // === Likert Questions ===
        timeline.push({
          type: jsPsychSurveyLikert,
          preamble: "<h3>Perceptions of Climate Change</h3>",
          questions: [
            { prompt: "In your view, how much do you think the temperature of the town has changed in the last 40 years?",
              labels: ['1 (remained the same)', '','','','','','','','', '10 (changed a lot)'],
              required: true },
            { prompt: "In your view, how much do you think the frequency at which the lake freezes has changed in Townsville in the last 40 years??",
              labels: ['1 (remained the same)', '','','','','','','','', '10 (changed a lot)'],
              required: true },
            { prompt: "In your view, how much do you think Townsville has been affected by climate change?",
              labels: ['1 (not affected at all)', '','','','','','','','', '10 (extremely affected)'],
              required: true },
          ]
        });

        // === Changepoint ===
        timeline.push({
          type: jsPsychSurveyHtmlForm,
          preamble: `<h3>Changepoint Detection</h3>
                     <p>At what year did you first notice a major shift or trend in the data?</p>
                     <p class="small-note">Years shown: ${YEAR_START}–${YEAR_END}</p>`,
          html: `
            <label for="changepoint">Select a year:</label>
            <select name="changepoint" required>
              <option value="">-- Select a year --</option>
              ${yearsAvailable.map(y => `<option value="${y}">${y}</option>`).join("")}
            </select>
          `
        });

        // === Attention recall ===
        timeline.push({
          type: jsPsychSurveyText,
          preamble: "<h3>Memory Check</h3>",
          questions: [{ prompt: "What word was shown earlier?", required: true }]
        });

        // === Save & finish ===
        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<div class="center-screen"><div>
            <p>You're done! Press any key to continue to the debriefing form.</p>
            <p class="small-note" id="save-status"></p>
          </div></div>`,
          on_finish: () => {
            jsPsych.data.get().localSave("csv", `climate_results_${is_binary ? "binary" : "continuous"}_${YEAR_START}-${YEAR_END}.csv`);
          }
        });

        /* === ✅ LOAD DEBRIEFING FORM === */
        timeline.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: async function() {
            const html = await fetch("debriefing.html").then(r => r.text());
            return html + `<p><strong>Press any key to finish.</strong></p>`;
          }
        });

        jsPsych.run(timeline);
      })
      .catch(error => {
        document.getElementById("jspsych-target").innerHTML = `
          <p style="color:#b00">⚠️ Error loading CSV "${chosen_file}".</p>
          <p>Make sure you are running this over a local server (not file://).<br>
          Try <code>python -m http.server 8000</code> and open <a href="http://localhost:8000" target="_blank">http://localhost:8000</a>.</p>
          <p>Error details: ${error.message}</p>`;
        console.error(error);
      });
  </script>
</body>
</html>
